<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>نظام ختم وتحقق التقارير</title>
<style>
body { font-family: Arial, sans-serif; background:#f5f6fa; color:#111; padding:20px; }
.card { background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 5px 15px rgba(0,0,0,.1); }
input, button { padding:10px; margin:5px 0; width:100%; border-radius:8px; border:1px solid #ccc; }
button { cursor:pointer; background:#4f8cff; color:#fff; font-weight:bold; border:none; }
#qrBox { margin-top:10px; }
</style>
<!-- مكتبات -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
if (typeof QRCode === 'undefined') {
    document.write('<script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"><\/script>');
}
</script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
</head>
<body>

<div class="card">
<h2>رفع التقرير</h2>
<input type="file" id="pdfFile" accept="application/pdf">
<button id="processBtn">توليد النسخ وQR</button>
<div id="log"></div>
</div>

<div class="card">
<h2>QR Code</h2>
<div id="qrBox"></div>
</div>

<script>
const $ = s=>document.querySelector(s);
const log = msg=>{ const d=document.createElement('div'); d.textContent=msg; $('#log').appendChild(d); }

// إعداد خط عربي مضمّن لاستخدامه داخل PDF
const ARABIC_FONT_URL = 'https://cdn.jsdelivr.net/gh/aliftype/amiri@master/ttf/Amiri-Regular.ttf';
let cachedArabicFontBytesPromise = null;
async function getArabicFontBytes(){
    if(!cachedArabicFontBytesPromise){
        cachedArabicFontBytesPromise = fetch(ARABIC_FONT_URL).then(r=>{
            if(!r.ok) throw new Error('تعذر تحميل الخط العربي');
            return r.arrayBuffer();
        }).then(buf=>new Uint8Array(buf));
    }
    return await cachedArabicFontBytesPromise;
}

// قاعدة عنوان واجهة البرمجة: تدعم الفتح عبر file:// مباشرةً
const API_BASE = (location && (location.protocol === 'file:' || location.origin === 'null')) ? 'http://localhost:3000' : '';

// دالة توليد hash مبسط (SHA-256)
async function generateHash(fileArrayBuffer){
    const hashBuffer = await crypto.subtle.digest('SHA-256', fileArrayBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
}

// توليد QR
function renderQR(text){
    $('#qrBox').innerHTML='';
    // المحاولة الأولى: مكتبة QRCode إن توفرت
    if (typeof QRCode !== 'undefined') {
        new QRCode($('#qrBox'), { text, width:150, height:150 });
        return;
    }
    // المحاولة الثانية: توليد صورة QR من خدمة عامة
    const img = document.createElement('img');
    img.width = 150;
    img.height = 150;
    img.alt = 'QR';
    img.onload = () => {
        // تمت تهيئة الـ QR بنجاح عبر الخدمة
    };
    img.onerror = () => {
        // المحاولة الثالثة: إظهار رابط فقط كحل أخير
        $('#qrBox').innerHTML = '';
        const a = document.createElement('a');
        a.href = text;
        a.textContent = 'فتح الرابط: ' + text;
        $('#qrBox').appendChild(a);
    };
    img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + encodeURIComponent(text);
    $('#qrBox').appendChild(img);
}

// إذا وُجد hash في عنوان الصفحة، اعرض QR فورًا
(function preRenderFromQuery(){
    try {
        const u = new URL(window.location.href);
        const hash = u.searchParams.get('hash');
        if (hash) {
            const qrBase = (API_BASE && API_BASE.length) ? API_BASE : window.location.origin;
            renderQR(qrBase + '/verify?hash=' + hash);
        }
    } catch(_) {}
})();

// ختم PDF (بصمة ورمز QR)
async function stampPDF(pdfBytes, hash){
    const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
    const pages = pdfDoc.getPages();
    pdfDoc.registerFontkit(fontkit);
    const font = await pdfDoc.embedFont(await getArabicFontBytes(), { subset: true });
    pages.forEach(p=>{
        p.drawText('نسخة أصلية للبنك', { x:20, y:20, size:12, font });
        p.drawText('Hash:'+hash.slice(0,10)+'...', { x:20, y:35, size:8, font });
    });
    return await pdfDoc.save();
}

// رفع الملف المختوم كاملاً إلى الخادم
async function uploadStamped(blob, originalName, hash){
    const form = new FormData();
    const stampedFile = new File([blob], 'original-'+originalName, { type: 'application/pdf' });
    form.append('file', stampedFile);
    form.append('hash', hash);
    let res;
    try {
        res = await fetch((API_BASE || '') + '/upload', { method: 'POST', body: form });
    } catch (networkErr) {
        throw new Error('تعذر الاتصال بالخادم. تأكد أن الخادم يعمل على ' + (API_BASE || window.location.origin));
    }
    if(!res.ok){
        let detail = '';
        try { const j = await res.json(); detail = j && j.message ? ' - ' + j.message : ''; } catch(_) {}
        throw new Error('رفع غير ناجح' + detail);
    }
    return await res.json();
}

$('#processBtn').addEventListener('click', async ()=>{
    const fileInput = $('#pdfFile');
    if(!fileInput.files.length){ alert('اختر ملف PDF'); return; }
    const file = fileInput.files[0];
    const arrayBuffer = await file.arrayBuffer();
    const hash = await generateHash(arrayBuffer);

    const stampedBytes = await stampPDF(arrayBuffer, hash);
    const blob = new Blob([stampedBytes], {type:'application/pdf'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'original-'+file.name;
    a.textContent = 'تحميل النسخة الأصلية للبنك';
    $('#log').appendChild(a);

    // عرض QR برابط التحقق مؤقتًا قبل الرفع
    const qrBaseInitial = (API_BASE && API_BASE.length) ? API_BASE : window.location.origin;
    renderQR(qrBaseInitial + '/verify?hash=' + hash);

    // رفع النسخة الأصلية المختومة كاملةً
    log('⬆️ جاري رفع النسخة الأصلية إلى الخادم...');
    try {
        const result = await uploadStamped(blob, file.name, hash);
        log('✅ تم رفع الملف كاملاً: ' + result.fileName);
        if (result.path) {
            const view = document.createElement('a');
            view.href = (API_BASE || '') + result.path;
            view.target = '_blank';
            view.textContent = 'عرض الملف المرفوع على الخادم';
            $('#log').appendChild(document.createElement('br'));
            $('#log').appendChild(view);
        }
        // بعد نجاح الرفع، حدِّث الـ QR ليشير إلى الملف على الخادم
        const qrBase = (API_BASE && API_BASE.length) ? API_BASE : window.location.origin;
        renderQR(qrBase + '/file?hash=' + hash);
    } catch(e){
        log('❌ فشل رفع الملف: ' + (e && e.message ? e.message : e));
    }

    // نسخة للعميل بعلامة مائية
    const clientPdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
    const pages = clientPdfDoc.getPages();
    clientPdfDoc.registerFontkit(fontkit);
    const font = await clientPdfDoc.embedFont(await getArabicFontBytes(), { subset: true });
    pages.forEach(p=>{
        p.drawText('نسخة للعميل – غير أصلية', { x:50, y:50, size:20, font, color:PDFLib.rgb(0.8,0.8,0.8), rotate:PDFLib.degrees(45) });
    });
    const clientBytes = await clientPdfDoc.save();
    const blobClient = new Blob([clientBytes], {type:'application/pdf'});
    const a2 = document.createElement('a');
    a2.href = URL.createObjectURL(blobClient);
    a2.download = 'client-'+file.name;
    a2.textContent = 'تحميل نسخة العميل';
    $('#log').appendChild(document.createElement('br'));
    $('#log').appendChild(a2);

    log('✅ تم توليد النسخ وQR بنجاح.');
});
</script>

</body>
</html>
